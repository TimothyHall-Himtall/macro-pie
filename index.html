<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Macro Pie ‚Ä¢ Multi‚ÄëDisease + Fast Scanner</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net"/>
<style>
  :root{
    --bg:#0f1115;--card:#151922;--ink:#e7ecf3;--muted:#9aa6bd;--line:#2b3140;
    --good:#19c37d;--warn:#f2c352;--bad:#e5484d;--accent:#5aa6ff;
    /* Macro slice colors */
    --fat-mono:#9ecbff;           /* light blue */
    --fat-poly:#7fb6ff;           /* light‚Äëmedium blue */
    --fat-other:#5aa6ff;          /* medium blue (when not indicated) */
    --fat-sat:#3c76c3;            /* medium‚Äëdark blue */
    --fat-trans:#214c92;          /* dark blue */
    --carb-fiber:#ff9a1f;         /* orange */
    --carb-sugar:#ffe04d;         /* yellow */
    --carb-added:#d8b100;         /* dark yellow */
    --carb-other:#fff08a;         /* light yellow */
  }
  html,body{margin:0;height:100%;background:var(--bg);color:var(--ink);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  header{position:sticky;top:0;z-index:10;background:rgba(15,17,21,.85);backdrop-filter:blur(10px);border-bottom:1px solid var(--line);padding:12px 16px;display:flex;gap:12px;align-items:center}
  header h1{margin:0;font-size:18px}
  main{padding:16px;display:grid;gap:16px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px}
  .row{display:grid;gap:12px}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .leftcol{display:grid;gap:12px;align-content:start}
  .rightcol{display:grid;gap:12px;align-content:start}
  @media(min-width:980px){main{grid-template-columns:520px 1fr}.leftcol{position:sticky;top:64px}}
  video{width:100%;border-radius:12px;background:#0b0d12}
  .btn{appearance:none;border:1px solid #3a4152;background:#1b2230;color:var(--ink);border-radius:12px;padding:12px 14px;font-weight:700;cursor:pointer}
  .btn:active{transform:scale(.99)}
  .btn-primary{background:#d32f2f;border-color:#7a1010}
  .btn-subtle{background:#0f1422;border-color:#2a3243}
  .stack{display:grid;gap:8px}
  .badges{display:grid;gap:6px}
  .badge{display:flex;align-items:center;gap:8px;border:1px solid #2e3546;background:#101523;padding:6px 10px;border-radius:999px;font-size:12px;width:max-content}
  .badge .dot{width:10px;height:10px;border-radius:999px}
  .b-good .dot{background:var(--good)}
  .b-warn .dot{background:var(--warn)}
  .b-bad  .dot{background:var(--bad)}
  .b-info .dot{background:var(--accent)}
  .list{display:grid;gap:6px}
  .kv{display:flex;gap:8px}
  .kv .k{width:140px;color:var(--muted)}
  .status{font-size:12px;color:var(--muted)}
  .sideInfo{display:grid;gap:8px}
  .togglePanel{display:grid;gap:8px}
  .toggleBtn{border:1px dashed #3a4152;background:#0f1422;color:var(--ink);padding:10px 12px;border-radius:12px;cursor:pointer;width:max-content}
  canvas{max-width:560px}
  .macroList{display:grid;gap:6px}
.log{white-space:pre-wrap;background:#0d1320;border:1px dashed #374058;border-radius:10px;padding:8px;color:#b8c7e0;max-height:160px;overflow:auto}
</style>
</head>
<body>
<header>
  <h1>üçΩÔ∏è Macro Pie</h1>
  <div class="status" id="topStatus">Scan a barcode or type one to begin.</div>
</header>

<main>
  <section class="leftcol">
    <section class="card row">
      <div class="grid2">
        <button id="scanBtn" class="btn btn-primary">üì∑ Start Scan</button>
        <div class="stack">
          <label class="status">Manual barcode</label>
          <div class="kv">
            <input id="barcodeInput" placeholder="e.g., 049000050103" style="flex:1;padding:10px 12px;border-radius:10px;border:1px solid #3a4152;background:#0f1422;color:var(--ink)">
            <button id="lookupBtn" class="btn btn-subtle">Lookup</button>
          </div>
        </div>
      </div>
      <video id="video" playsinline muted></video>
      <div class="kv">
        <button id="torchBtn" class="btn btn-subtle">üî¶ Torch</button>
        <button id="switchBtn" class="btn btn-subtle">üîÅ Switch Camera</button>
        <button id="diagBtn" class="btn btn-subtle">üß™ Diagnostics</button>
        <button id="forceZXingBtn" class="btn btn-subtle">üß© Force ZXing</button>
        <span id="camStatus" class="status"></span>
      </div>
      <div id="errLog" class="log" style="display:none"></div>
    </section>

    <section class="card row">
      <canvas id="pie" height="360"></canvas>
      <div class="sideInfo">
        <div class="togglePanel">
          <button id="centerToggle" class="toggleBtn">Show: Total Calories</button>
          <div id="centerReadout" class="status">Tap to cycle: Calories ‚Üí Protein (g) ‚Üí Net Carbs (g) ‚Üí Sodium (mg)</div>
        </div>
        <div class="macroList" id="macroList"></div>
      </div>
    </section>
  </section>

  <section class="rightcol">
    <section class="card row">
      <div class="list" id="productMeta"></div>
      <div class="badges" id="badges"></div>
    </section>

    <section class="card row">
      <h3 style="margin:0">Multi‚ÄëDisease Risk</h3>
      <div class="badges" id="diseaseBadges"></div>
      <div class="list" id="diseaseList"></div>
    </section>
  </section>
</main>

<!-- Chart.js for the pie -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<!-- ZXing for fast barcode scanning -->
<script src="https://cdn.jsdelivr.net/npm/@zxing/browser@0.1.5/umd/index.min.js"></script>
<script>
/***** Utilities *****/
// helpers injected
function setStatus(msg){ const el=document.getElementById('camStatus'); if(el) el.textContent=msg; }
(function(){ const log=document.getElementById('errLog'); function show(m){ if(!log)return; log.style.display='block'; log.textContent+=(log.textContent?'
':'')+m; } window.addEventListener('error',e=>show('JS Error: '+e.message)); window.addEventListener('unhandledrejection',e=>show('Promise: '+(e.reason&&e.reason.message||e.reason))); })();
const $ = (id)=>document.getElementById(id);
const fmtPct = (x)=> (x*100).toFixed(0)+'%';
const clamp=(x,a=0,b=1)=>Math.max(a,Math.min(b,x));

/***** Camera / Scanner *****/
let currentDeviceId = null; let stream = null; let codeReader = null; let torchOn=false;
// Added: globals for detector flow
let usingNativeDetector = 'BarcodeDetector' in window;
let rafId = null; let detector = null;
async function startScan(){
  $('camStatus').textContent='Initializing‚Ä¶';
  if (!isSecureContext){ $('camStatus').textContent='Site must be HTTPS for camera access.'; return; }
  try{
    // Warm permission
    try{ const warm = await navigator.mediaDevices.getUserMedia({video:true,audio:false}); warm.getTracks().forEach(t=>t.stop()); }catch{}

    // Try a slightly higher resolution for better barcode clarity
    const constraints = { video:{ width:{ideal:1280} }, audio:false };
    try{ stream = await navigator.mediaDevices.getUserMedia(constraints); }
    catch(err){
      try{ stream = await navigator.mediaDevices.getUserMedia({ video:true, audio:false }); }
      catch(err2){ $('camStatus').textContent='Camera error: '+(err2.name||'error'); return; }
    }

    const videoEl = $('video');
    videoEl.srcObject = stream; try{ await videoEl.play(); }catch{}
    $('camStatus').textContent='Camera ready';

    // Native first with timed fallback to ZXing (some PCs support API but detect poorly)
    if ('BarcodeDetector' in window){
      let detected=false;
      try{
        detector ||= new BarcodeDetector({ formats:['ean_13','ean_8','upc_a','upc_e','code_128'] });
        const loop = async ()=>{
          try{
            const codes = await detector.detect(videoEl);
            if (codes && codes[0]){
              const val=codes[0].rawValue || codes[0].displayValue; detected=!!val;
              if (val){ stopScan(); $('camStatus').textContent='Found barcode: '+val; $('barcodeInput').value=val; lookupByBarcode(val); return; }
            }
          }catch{}
          rafId = requestAnimationFrame(loop);
        };
        rafId = requestAnimationFrame(loop);
        // Fallback after 3000ms if nothing found
        setTimeout(()=>{ if (!detected) { try{ if (rafId) cancelAnimationFrame(rafId); }catch{} startZXingDecode(); } }, 3000);
      }catch(e){ await startZXingDecode(); }
    } else {
      await startZXingDecode();
    }
  }catch(e){ $('camStatus').textContent='Camera error: '+(e.name||'error'); }
}

// --- Dynamic ZXing loader helpers ---
function loadScript(src){
  return new Promise((resolve, reject)=>{ const s=document.createElement('script'); s.src=src; s.async=true; s.onload=()=>resolve(); s.onerror=()=>reject(new Error('Failed '+src)); document.head.appendChild(s); });
}
async function ensureZXing(){
  if (window.ZXingBrowser) return 'browser';
  if (window.ZXing) return 'library';
  const urls=[
    'https://cdn.jsdelivr.net/npm/@zxing/browser@0.1.5/umd/index.min.js',
    'https://unpkg.com/@zxing/library@0.20.0',
    'https://cdn.jsdelivr.net/npm/@zxing/library@0.20.0'
  ];
  for (const u of urls){ try{ await loadScript(u); if (window.ZXingBrowser) return 'browser'; if (window.ZXing) return 'library'; }catch(e){} }
  throw new Error('ZXing libraries could not be loaded');
}

async function startZXingDecode(){
  try{
    setStatus('Loading ZXing‚Ä¶');
    const api = await ensureZXing(); // 'browser' | 'library'
    const F = (api==='browser' ? ZXingBrowser.BarcodeFormat : ZXing.BarcodeFormat);
    if (!codeReader){
      const formats=[F.EAN_13,F.EAN_8,F.UPC_A,F.UPC_E,F.CODE_128];
      if (api==='browser'){
        const hints=new Map(); hints.set(ZXingBrowser.DecodeHintType.POSSIBLE_FORMATS, formats);
        codeReader = new ZXingBrowser.BrowserMultiFormatReader(hints);
      } else {
        const hints=new Map(); hints.set(ZXing.DecodeHintType.POSSIBLE_FORMATS, formats);
        codeReader = new ZXing.BrowserMultiFormatReader(hints);
      }
    }
    await codeReader.decodeFromVideoDevice(null, 'video', (result, err, controls)=>{
      if (result){ controls.stop(); setStatus('Found barcode: '+result.getText()); $('barcodeInput').value=result.getText(); lookupByBarcode(result.getText()); }
    });
    setStatus('Scanning (ZXing)‚Ä¶');
  }catch(e){ setStatus('Scanner init failed: '+(e.name||e.message||'error')); }
}

async function switchCamera(){
  const devices = await ZXingBrowser.BrowserCodeReader.listVideoInputDevices();
  if (!devices.length) return;
  const idx = devices.findIndex(d=>d.deviceId===currentDeviceId);
  const next = devices[(idx+1)%devices.length];
  stopScan(); currentDeviceId = next.deviceId; startScan();
}
function stopScan(){ try{ if (codeReader) codeReader.reset(); if (stream){stream.getTracks().forEach(t=>t.stop()); stream=null;} }catch{} }
async function toggleTorch(){
  try{
    const track = stream?.getVideoTracks?.()[0]; if (!track) return;
    await track.applyConstraints({advanced:[{torch:!torchOn}]});
    torchOn = !torchOn; $('torchBtn').textContent = torchOn? 'üî¶ Torch On' : 'üî¶ Torch';
  }catch{ $('camStatus').textContent = 'Torch not supported on this device.'; }
}

/***** OpenFoodFacts API fetch *****/
async function lookupByBarcode(code){
  $('topStatus').textContent = 'Looking up product‚Ä¶';
  try{
    const res = await fetch(`https://world.openfoodfacts.org/api/v2/product/${code}.json`);
    const data = await res.json();
    if (!data || data.status!==1) { $('topStatus').textContent='No product found'; return; }
    renderProduct(data.product);
  }catch(e){ $('topStatus').textContent='Lookup failed. Check connection.'; }
}

/***** Macro breakdown + color scheme *****/
function getNutriments(p){
  const n = p.nutriments || {};
  // grams per serving preferred; fall back to 100g
  const basis = n.serving_size ? 'serving' : '100g';
  const suf = basis==='serving' ? '_serving' : '';
  const g = (k)=> Number(n[k+suf] ?? n[k+'_100g'] ?? 0);
  const fat = g('fat');
  const fatMono = g('monounsaturated-fat');
  const fatPoly = g('polyunsaturated-fat');
  const fatSat = g('saturated-fat');
  const fatTrans = g('trans-fat');
  const fatOther = Math.max(fat - (fatMono+fatPoly+fatSat+fatTrans), 0);
  const carbs = g('carbohydrates');
  const fiber = g('fiber');
  const sugars = g('sugars');
  const added = g('added-sugars');
  const sugarsTotal = sugars; // may include added
  const carbsOther = Math.max(carbs - (fiber + sugarsTotal), 0);
  const protein = g('proteins');
  const sodiumG = Number(n['sodium'+suf] ?? n['sodium_100g'] ?? 0); // grams
  const sodiumMg = sodiumG*1000;
  const kcal = Number(n['energy-kcal'+suf] ?? n['energy-kcal_100g'] ?? 0);
  // Net carbs (exclude fiber; polyols if available)
  const polyols = g('polyols');
  const netCarbs = Math.max(carbs - fiber - polyols, 0);
  return {basis, kcal, fat, fatMono, fatPoly, fatSat, fatTrans, fatOther, carbs, fiber, sugarsTotal, added, carbsOther, protein, sodiumMg, netCarbs};
}

function buildPie(parts){
  const ctx = $('pie').getContext('2d');
  const slices = [];
  const labels = [];
  const colors = [];
  const addSlice=(val,label,color)=>{ if (val>0){ slices.push(val); labels.push(label); colors.push(color);} };
  // Fats (blue family)
  addSlice(parts.fatMono,  `M ${pct(parts.fatMono,parts)}`,  getComputedStyle(document.documentElement).getPropertyValue('--fat-mono'));
  addSlice(parts.fatPoly,  `P ${pct(parts.fatPoly,parts)}`,  getComputedStyle(document.documentElement).getPropertyValue('--fat-poly'));
  addSlice(parts.fatOther, `O ${pct(parts.fatOther,parts)}`, getComputedStyle(document.documentElement).getPropertyValue('--fat-other'));
  addSlice(parts.fatSat,   `S ${pct(parts.fatSat,parts)}`,   getComputedStyle(document.documentElement).getPropertyValue('--fat-sat'));
  addSlice(parts.fatTrans, `T ${pct(parts.fatTrans,parts)}`, getComputedStyle(document.documentElement).getPropertyValue('--fat-trans'));
  // Carbs (yellow/orange family)
  addSlice(parts.fiber,    `F ${pct(parts.fiber,parts)}`,    getComputedStyle(document.documentElement).getPropertyValue('--carb-fiber'));
  addSlice(parts.sugarsTotal,`Su ${pct(parts.sugarsTotal,parts)}`, getComputedStyle(document.documentElement).getPropertyValue('--carb-sugar'));
  addSlice(parts.added,    `A ${pct(parts.added,parts)}`,    getComputedStyle(document.documentElement).getPropertyValue('--carb-added'));
  addSlice(parts.carbsOther,`C ${pct(parts.carbsOther,parts)}`, getComputedStyle(document.documentElement).getPropertyValue('--carb-other'));

  const chart = new Chart(ctx, {
    type:'doughnut',
    data:{ labels, datasets:[{ data:slices, backgroundColor:colors, borderColor:'#0b0d12', borderWidth:2 }]},
    options:{
      cutout:'58%',
      plugins:{ legend:{ display:false }, tooltip:{ callbacks:{ label:(c)=> c.label.replace(/^(\w+) /,'$1 ')+': '+c.formattedValue+' g' } } },
      layout:{ padding:8 },
      animation:{ duration:300 }
    }
  });
  return chart;
}
function pct(val, parts){
  const total = parts.fatMono+parts.fatPoly+parts.fatOther+parts.fatSat+parts.fatTrans+parts.fiber+parts.sugarsTotal+parts.added+parts.carbsOther+parts.protein;
  return total>0 ? Math.round((val/total)*100)+'%' : '0%';
}

/***** Disease scoring *****/
function computeDiseaseScores(n, ingredients=[], meta={}){
  const grams = (k)=>Number(n[k] ?? 0);
  const z=(x,k)=>x/k; const clamp=(x,a=0,b=10)=>Math.max(a,Math.min(b,x));
  const protein   = grams('protein');
  const fiber     = grams('fiber');
  const sugars    = grams('sugarsTotal');
  const satFat    = grams('fatSat');
  const transFat  = grams('fatTrans');
  const sodiumMg  = Number(n.sodiumMg||0);
  const netCarbs  = Number(n.netCarbs||0);
  const isUltra   = (meta.nova===4) || /artificial|preserv|emulsifier|maltodextrin|color/i.test((ingredients||[]).join(' '));
  const has = (...ks)=> (ingredients||[]).some(t=>ks.some(k=>t.includes(k)));
  const processedMeat = has('nitrite','nitrate','sodium nitrite','bologna','pepperoni','salami','sausage','bacon','ham');
  const dyes = has('red 40','yellow 5','yellow 6','blue 1','blue 2');
  const sweeteners = has('aspartame','acesulfame','saccharin','sucralose');
  const seedOils = has('soybean oil','corn oil','cottonseed oil','canola oil','sunflower oil');

  const cancer = 3.0*z(sugars,20)+2.2*z(satFat,10)+2.5*(transFat>0?1:0)+3.0*z(sodiumMg,2000)+2.8*(processedMeat?1:0)+2.0*(dyes?1:0)+2.2*(isUltra?1:0)-1.8*z(fiber,8)-0.6*z(protein,30);
  const diabetes = 4.0*z(sugars,20)+3.0*z(Math.max(netCarbs,0),40)+1.0*z(sodiumMg,2000)+1.5*(sweeteners?1:0)+1.5*(isUltra?1:0)-2.5*z(fiber,8)-0.7*z(protein,30);
  const cvd = 3.2*z(sodiumMg,2000)+3.2*z(satFat,10)+2.5*(transFat>0?1:0)+1.5*(seedOils?1:0)+1.5*(isUltra?1:0)-2.0*z(fiber,8);
  const nafld = 3.8*z(sugars,20)+2.8*z(Math.max(netCarbs,0),40)+1.5*z(satFat,10)+1.5*(isUltra?1:0)-1.5*z(fiber,8);
  const dementia = 2.4*(isUltra?1:0)+2.0*z(sugars,20)+1.8*z(satFat,10)+1.2*z(sodiumMg,2000)-1.8*z(fiber,8);
  const gout = 3.0*(processedMeat?1:0)+1.2*z(sugars,20);
  const scores = { cancer:clamp(cancer), diabetes:clamp(diabetes), cvd:clamp(cvd), nafld:clamp(nafld), dementia:clamp(dementia), gout:clamp(gout) };
  const overall = clamp(0.28*scores.cancer+0.28*scores.diabetes+0.22*scores.cvd+0.12*scores.nafld+0.08*scores.dementia+0.02*scores.gout);
  return { ...scores, overall };
}

/***** Renderers *****/
let pieChart=null; let cycleIdx=0; // 0 kcal, 1 protein, 2 net carbs, 3 sodium
function renderProduct(p){
  const parts = getNutriments(p);
  const meta = { nova: p.nova_group, alcohol_g: 0 };
  const ingredients = (p.ingredients_text || '').toLowerCase().split(/[,;()]/).map(s=>s.trim()).filter(Boolean);

  // Header/meta
  const brand = p.brands || 'Unknown Brand';
  const name = p.product_name || 'Unknown Product';
  $('productMeta').innerHTML = `
    <div class="kv"><div class="k">Name</div><div>${name}</div></div>
    <div class="kv"><div class="k">Brand</div><div>${brand}</div></div>
    <div class="kv"><div class="k">Serving Basis</div><div>${parts.basis}</div></div>
  `;

  // Pie
  if (pieChart){ pieChart.destroy(); }
  pieChart = buildPie({...parts});

  // Macro list (left‚Äëaligned, one column)
  $('macroList').innerHTML = `
    <div>Protein: <b>${parts.protein.toFixed(1)} g</b></div>
    <div>Fat: <b>${parts.fat.toFixed(1)} g</b> (Mono ${parts.fatMono.toFixed(1)}, Poly ${parts.fatPoly.toFixed(1)}, Sat ${parts.fatSat.toFixed(1)}, Trans ${parts.fatTrans.toFixed(1)}, Other ${parts.fatOther.toFixed(1)})</div>
    <div>Carbs: <b>${parts.carbs.toFixed(1)} g</b> (Fiber ${parts.fiber.toFixed(1)}, Sugar ${parts.sugarsTotal.toFixed(1)}, Added ${parts.added.toFixed(1)}, Other ${parts.carbsOther.toFixed(1)})</div>
    <div>Net Carbs: <b>${parts.netCarbs.toFixed(1)} g</b></div>
    <div>Sodium: <b>${Math.round(parts.sodiumMg)} mg</b></div>
    <div>Calories: <b>${Math.round(parts.kcal)} kcal</b></div>
  `;

  // Center toggle (moved to the right as requested earlier)
  cycleIdx=0; updateCenter(parts);
  $('centerToggle').onclick=()=>{ cycleIdx=(cycleIdx+1)%4; updateCenter(parts); };

  // App badges (stacked, only non-neutral)
  renderBadges(parts, p);

  // Disease panel
  renderDisease(parts, ingredients, meta);

  $('topStatus').textContent = 'Loaded: '+name;
}

function updateCenter(parts){
  const map=[
    {label:'Total Calories', value: Math.round(parts.kcal)+' kcal'},
    {label:'Protein', value: parts.protein.toFixed(1)+' g'},
    {label:'Net Carbs', value: parts.netCarbs.toFixed(1)+' g'},
    {label:'Sodium', value: Math.round(parts.sodiumMg)+' mg'}
  ];
  $('centerToggle').textContent = 'Show: '+map[cycleIdx].label;
  $('centerReadout').textContent = map[cycleIdx].value;
}

function addBadge(container, text, level){
  // level: good|warn|bad|info
  const div=document.createElement('div');
  div.className='badge b-'+(level||'info');
  div.innerHTML = `<span class="dot"></span><span>${text}</span>`;
  container.appendChild(div);
}

function renderBadges(parts, p){
  const el=$('badges'); el.innerHTML='';
  // thresholds
  const highProtein = parts.protein>=20;
  const lowSugar = parts.added<=5 && parts.sugarsTotal<=8;
  const highFiber = parts.fiber>=5;
  const highSodium = parts.sodiumMg>=600; const lowSodium=parts.sodiumMg<=140;
  const keto = (parts.netCarbs<=8 && parts.fiber>=3) || (parts.netCarbs<=5);
  const processed = (p.nova_group===4);

  if (keto) addBadge(el,'Keto‚ÄëFriendly','good');
  if (highProtein) addBadge(el,'High‚ÄëProtein','good');
  if (highFiber) addBadge(el,'High‚ÄëFiber','good');
  if (lowSugar) addBadge(el,'Low‚ÄëSugar','good');
  if (lowSodium) addBadge(el,'Low‚ÄëSodium','good');
  if (highSodium) addBadge(el,'High‚ÄëSodium','bad');
  if (processed) addBadge(el,'High‚ÄëProcessed','warn');
}

function renderDisease(parts, ingredients, meta){
  const scores = computeDiseaseScores({
    protein:parts.protein, fiber:parts.fiber, sugarsTotal:parts.sugarsTotal,
    fatSat:parts.fatSat, fatTrans:parts.fatTrans, sodiumMg:parts.sodiumMg,
    netCarbs:parts.netCarbs
  }, ingredients, meta);

  const db=$('diseaseBadges'); db.innerHTML='';
  const dl=$('diseaseList'); dl.innerHTML='';

  const rows=[
    ['Overall Risk', scores.overall],
    ['Cancer', scores.cancer],
    ['Diabetes', scores.diabetes],
    ['Cardiovascular', scores.cvd],
    ['Fatty Liver (NAFLD)', scores.nafld],
    ['Dementia', scores.dementia],
    ['Gout', scores.gout]
  ];
  for (const [label,val] of rows){
    const level = val>=7?'bad': val>=4?'warn':'good';
    addBadge(db, `${label}: ${val.toFixed(1)}/10`, level);
  }

  // detailed list
  dl.innerHTML = rows.map(([l,v])=>`<div class="kv"><div class="k">${l}</div><div>${v.toFixed(1)} / 10</div></div>`).join('');
}

 /***** Diagnostics *****/
async function runDiagnostics(){
  const parts=[];
  parts.push('Secure Context: '+(isSecureContext?'yes':'NO (need HTTPS)'));
  parts.push('mediaDevices: '+(navigator.mediaDevices?'ok':'missing'));
  try{
    const list = await navigator.mediaDevices.enumerateDevices();
    const vids = list.filter(d=>d.kind==='videoinput');
    parts.push('Video Inputs: '+vids.length);
    parts.push('Labels: '+vids.map(v=>v.label||'(no label until allowed)').join(' | '));
  }catch(e){ parts.push('enumerateDevices failed: '+e.name); }
  $('camStatus').textContent = parts.join(' ‚Ä¢ ');
}

/***** Events *****/
$('scanBtn').onclick = ()=>{ stopScan(); startScan(); };
$('switchBtn').onclick = switchCamera;
$('torchBtn').onclick = toggleTorch;
$('lookupBtn').onclick = ()=>{ const code=$('barcodeInput').value.trim(); if (code) lookupByBarcode(code); };
$('diagBtn').onclick = runDiagnostics;
$('forceZXingBtn').onclick = ()=>{ try{ if (rafId){ cancelAnimationFrame(rafId); rafId=null; } }catch{} startZXingDecode(); };
