<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Macro Pie ‚Ä¢ Multi-Disease + Fast Scanner (Diag+Safe Bind)</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net"/>
<style>
  :root{
    --bg:#0f1115;--card:#151922;--ink:#e7ecf3;--muted:#9aa6bd;--line:#2b3140;
    --good:#19c37d;--warn:#f2c352;--bad:#e5484d;--accent:#5aa6ff;
    /* Macro colors */
    --fat-mono:#9ecbff; --fat-poly:#7fb6ff; --fat-other:#5aa6ff; --fat-sat:#3c76c3; --fat-trans:#214c92;
    --carb-fiber:#ff9a1f; --carb-sugar:#ffe04d; --carb-added:#d8b100; --carb-other:#fff08a;
  }
  html,body{margin:0;height:100%;background:var(--bg);color:var(--ink);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  header{position:sticky;top:0;z-index:10;background:rgba(15,17,21,.85);backdrop-filter:blur(10px);border-bottom:1px solid var(--line);padding:12px 16px;display:flex;gap:12px;align-items:center}
  header h1{margin:0;font-size:18px}
  main{padding:16px;display:grid;gap:16px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px}
  .row{display:grid;gap:12px}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .leftcol{display:grid;gap:12px;align-content:start}
  .rightcol{display:grid;gap:12px;align-content:start}
  @media(min-width:980px){main{grid-template-columns:520px 1fr}.leftcol{position:sticky;top:64px}}
  video{width:100%;border-radius:12px;background:#0b0d12}
  .btn{appearance:none;border:1px solid #3a4152;background:#1b2230;color:var(--ink);border-radius:12px;padding:12px 14px;font-weight:700;cursor:pointer}
  .btn:active{transform:scale(.99)}
  .btn-primary{background:#d32f2f;border-color:#7a1010}
  .btn-subtle{background:#0f1422;border-color:#2a3243}
  .stack{display:grid;gap:8px}
  .badges{display:grid;gap:6px}
  .badge{display:flex;align-items:center;gap:8px;border:1px solid #2e3546;background:#101523;padding:6px 10px;border-radius:999px;font-size:12px;width:max-content}
  .badge .dot{width:10px;height:10px;border-radius:999px}
  .b-good .dot{background:var(--good)}
  .b-warn .dot{background:var(--warn)}
  .b-bad  .dot{background:var(--bad)}
  .b-info .dot{background:var(--accent)}
  .list{display:grid;gap:6px}
  .kv{display:flex;gap:8px}
  .kv .k{width:140px;color:var(--muted)}
  .status{font-size:12px;color:var(--muted)}
  .sideInfo{display:grid;gap:8px}
  .togglePanel{display:grid;gap:8px}
  .toggleBtn{border:1px dashed #3a4152;background:#0f1422;color:var(--ink);padding:10px 12px;border-radius:12px;cursor:pointer;width:max-content}
  canvas{max-width:560px}
  .macroList{display:grid;gap:6px}
  .log{white-space:pre-wrap;background:#0d1320;border:1px dashed #374058;border-radius:10px;padding:8px;color:#b8c7e0;max-height:160px;overflow:auto}
</style>
</head>
<body>
<header>
  <h1>üçΩÔ∏è Macro Pie</h1>
  <div class="status" id="topStatus">Scan a barcode or type one to begin.</div>
</header>

<main>
  <section class="leftcol">
    <section class="card row">
      <div class="grid2">
        <button id="scanBtn" class="btn btn-primary">üì∑ Start Scan</button>
        <div class="stack">
          <label class="status">Manual barcode</label>
          <div class="kv">
            <input id="barcodeInput" placeholder="e.g., 049000050103" style="flex:1;padding:10px 12px;border-radius:10px;border:1px solid #3a4152;background:#0f1422;color:var(--ink)">
            <button id="lookupBtn" class="btn btn-subtle">Lookup</button>
          </div>
        </div>
      </div>
      <video id="video" playsinline muted></video>
      <div class="kv">
        <button id="torchBtn" class="btn btn-subtle">üî¶ Torch</button>
        <button id="switchBtn" class="btn btn-subtle">üîÅ Switch Camera</button>
        <button id="diagBtn" class="btn btn-subtle">üß™ Diagnostics</button>
        <span id="camStatus" class="status"></span>
      </div>
      <div id="errLog" class="log" style="display:none"></div>
    </section>

    <section class="card row">
      <canvas id="pie" height="360"></canvas>
      <div class="sideInfo">
        <div class="togglePanel">
          <button id="centerToggle" class="toggleBtn">Show: Total Calories</button>
          <div id="centerReadout" class="status">Tap to cycle: Calories ‚Üí Protein (g) ‚Üí Net Carbs (g) ‚Üí Sodium (mg)</div>
        </div>
        <div class="macroList" id="macroList"></div>
      </div>
    </section>
  </section>

  <section class="rightcol">
    <section class="card row">
      <div class="list" id="productMeta"></div>
      <div class="badges" id="badges"></div>
    </section>

    <section class="card row">
      <h3 style="margin:0">Multi-Disease Risk</h3>
      <div class="badges" id="diseaseBadges"></div>
      <div class="list" id="diseaseList"></div>
    </section>
  </section>
</main>

<!-- libraries load first; our code runs after DOM via DOMContentLoaded -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@zxing/browser@0.1.5/umd/index.min.js"></script>
<script>
/***** Error log & safe event binding *****/
(function(){
  const q=(id)=>document.getElementById(id);
  const log=q('errLog');
  function show(msg){ if(!log)return; log.style.display='block'; log.textContent += (log.textContent?"\n":"")+msg; }
  window.addEventListener('error', (e)=>{ show('JS Error: '+e.message+' @ '+(e.filename||'')+':'+(e.lineno||'')); });
  window.addEventListener('unhandledrejection', (e)=>{ show('Promise Rejection: '+(e.reason&&e.reason.message||e.reason)); });

  function bindUI(){
    if (!window.Chart){ show('Chart.js not loaded yet.'); }
    if (!window.ZXingBrowser){ show('ZXing not loaded yet. Using native detector if available.'); }

    q('scanBtn')?.addEventListener('click', ()=>{ console.log('scan click'); stopScan(); startScan(); });
    q('switchBtn')?.addEventListener('click', ()=>{ console.log('switch click'); switchCamera(); });
    q('torchBtn')?.addEventListener('click', ()=>{ console.log('torch click'); toggleTorch(); });
    q('lookupBtn')?.addEventListener('click', ()=>{ console.log('lookup click'); const code=q('barcodeInput').value.trim(); if (code) lookupByBarcode(code); });
    q('diagBtn')?.addEventListener('click', ()=>{ console.log('diag click'); runDiagnostics(); });
  }

  if (document.readyState==='complete' || document.readyState==='interactive'){
    bindUI();
  } else {
    document.addEventListener('DOMContentLoaded', bindUI);
  }
})();

/***** Helpers *****/
const $ = (id)=>document.getElementById(id);
const pct=(val, parts)=>{ const t= parts.fatMono+parts.fatPoly+parts.fatOther+parts.fatSat+parts.fatTrans+parts.fiber+parts.sugarsTotal+parts.added+parts.carbsOther+parts.protein; return t>0 ? Math.round((val/t)*100)+'%' : '0%'; };
function setStatus(msg){ const el=$('camStatus'); if (el) el.textContent=msg; }

/***** Camera / Scanner *****/
let currentDeviceId=null, stream=null, codeReader=null, torchOn=false;
let usingNativeDetector = 'BarcodeDetector' in window; let rafId=null, detector=null;

async function startScan(){
  setStatus('Initializing‚Ä¶');
  if (!isSecureContext){ setStatus('Site must be HTTPS for camera access.'); return; }
  try{
    // Warm permission (ignore failures)
    try{ const warm=await navigator.mediaDevices.getUserMedia({video:true,audio:false}); warm.getTracks().forEach(t=>t.stop()); }catch{}
    // SIMPLE constraints first
    try{ stream = await navigator.mediaDevices.getUserMedia({ video:true, audio:false }); }
    catch(err){ setStatus('Camera error: '+(err.name||'error')); return; }

    const videoEl = $('video');
    videoEl.srcObject = stream; try{ await videoEl.play(); }catch{}
    setStatus('Camera ready');

    if ('BarcodeDetector' in window){
      try{
        detector ||= new BarcodeDetector({ formats:['ean_13','ean_8','upc_a','upc_e','code_128'] });
        const loop = async ()=>{
          try{
            const codes = await detector.detect(videoEl);
            if (codes && codes[0]){
              const val = codes[0].rawValue || codes[0].displayValue;
              if (val){ stopScan(); setStatus('Found barcode: '+val); $('barcodeInput').value=val; lookupByBarcode(val); return; }
            }
          }catch{}
          rafId = requestAnimationFrame(loop);
        };
        rafId = requestAnimationFrame(loop);
      }catch(e){ await startZXingDecode(); }
    } else {
      await startZXingDecode();
    }
  }catch(e){ setStatus('Camera error: '+(e.name||'error')); }
}

async function startZXingDecode(){
  try{
    if (!window.ZXingBrowser){ setStatus('ZXing library not ready'); return; }
    if (!codeReader){
      const F=ZXingBrowser.BarcodeFormat; const formats=[F.EAN_13,F.EAN_8,F.UPC_A,F.UPC_E,F.CODE_128];
      const hints=new Map(); hints.set(ZXingBrowser.DecodeHintType.POSSIBLE_FORMATS, formats);
      codeReader = new ZXingBrowser.BrowserMultiFormatReader(hints);
    }
    await codeReader.decodeFromVideoDevice(currentDeviceId||null, 'video', (result, err, controls)=>{
      if (result){ controls.stop(); setStatus('Found barcode: '+result.getText()); $('barcodeInput').value=result.getText(); lookupByBarcode(result.getText()); }
    });
  }catch(e){ setStatus('Scanner init failed: '+(e.name||'error')); }
}

async function switchCamera(){
  try{
    if (!window.ZXingBrowser){ setStatus('ZXing not loaded'); return; }
    const devices = await ZXingBrowser.BrowserCodeReader.listVideoInputDevices();
    if (!devices.length){ setStatus('No other cameras detected.'); return; }
    const idx = devices.findIndex(d=>d.deviceId===currentDeviceId);
    const next = devices[(idx+1+devices.length)%devices.length];
    stopScan(); currentDeviceId = next.deviceId; startScan();
  }catch{ setStatus('No other cameras detected.'); }
}

function stopScan(){
  try{ if (rafId){ cancelAnimationFrame(rafId); rafId=null; } }catch{}
  try{ if (codeReader){ codeReader.reset(); } }catch{}
  try{ if (stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; } }catch{}
}

async function toggleTorch(){
  try{
    const track = stream?.getVideoTracks?.()[0]; if (!track) return;
    await track.applyConstraints({advanced:[{torch:!torchOn}]});
    torchOn=!torchOn; const b=$('torchBtn'); if(b) b.textContent = torchOn? 'üî¶ Torch On' : 'üî¶ Torch';
  }catch{ setStatus('Torch not supported on this device.'); }
}

/***** OpenFoodFacts *****/
async function lookupByBarcode(code){
  const top=$('topStatus'); if(top) top.textContent='Looking up product‚Ä¶';
  try{
    const res = await fetch(`https://world.openfoodfacts.org/api/v2/product/${code}.json`);
    const data = await res.json();
    if (!data || data.status!==1){ if(top) top.textContent='No product found'; return; }
    renderProduct(data.product);
  }catch(e){ if(top) top.textContent='Lookup failed. Check connection.'; }
}

/***** Macro breakdown & pie *****/
function getNutriments(p){
  const n = p.nutriments || {};
  const basis = n.serving_size ? 'serving' : '100g';
  const suf = basis==='serving' ? '_serving' : '';
  const g = (k)=> Number(n[k+suf] ?? n[k+'_100g'] ?? 0);
  const fat=g('fat'), fM=g('monounsaturated-fat'), fP=g('polyunsaturated-fat'), fS=g('saturated-fat'), fT=g('trans-fat');
  const fO = Math.max(fat-(fM+fP+fS+fT),0);
  const carbs=g('carbohydrates'), fiber=g('fiber'), sugars=g('sugars'), added=g('added-sugars');
  const cO = Math.max(carbs-(fiber+sugars),0);
  const protein=g('proteins');
  const sodiumMg = (Number(n['sodium'+suf] ?? n['sodium_100g'] ?? 0))*1000;
  const kcal = Number(n['energy-kcal'+suf] ?? n['energy-kcal_100g'] ?? 0);
  const polyols=g('polyols'); const netCarbs=Math.max(carbs-fiber-polyols,0);
  return {basis:kbasis=basis, kcal, fat, fatMono:fM, fatPoly:fP, fatSat:fS, fatTrans:fT, fatOther:fO, carbs, fiber, sugarsTotal:sugars, added, carbsOther:cO, protein, sodiumMg, netCarbs};
}
function buildPie(parts){
  const ctx=$('pie').getContext('2d');
  const css=(v)=>getComputedStyle(document.documentElement).getPropertyValue(v).trim();
  const data=[]; const labels=[]; const colors=[]; const add=(v,l,c)=>{ if(v>0){ data.push(v); labels.push(l); colors.push(css(c)); } };
  add(parts.fatMono,  `M ${pct(parts.fatMono,parts)}`,  '--fat-mono');
  add(parts.fatPoly,  `P ${pct(parts.fatPoly,parts)}`,  '--fat-poly');
  add(parts.fatOther, `O ${pct(parts.fatOther,parts)}`, '--fat-other');
  add(parts.fatSat,   `S ${pct(parts.fatSat,parts)}`,   '--fat-sat');
  add(parts.fatTrans, `T ${pct(parts.fatTrans,parts)}`, '--fat-trans');
  add(parts.fiber,       `F ${pct(parts.fiber,parts)}`,       '--carb-fiber');
  add(parts.sugarsTotal, `Su ${pct(parts.sugarsTotal,parts)}`, '--carb-sugar');
  add(parts.added,       `A ${pct(parts.added,parts)}`,       '--carb-added');
  add(parts.carbsOther,  `C ${pct(parts.carbsOther,parts)}`,  '--carb-other');
  if (window._pieObj) window._pieObj.destroy();
  window._pieObj = new Chart(ctx,{type:'doughnut',data:{labels,datasets:[{data,backgroundColor:colors,borderColor:'#0b0d12',borderWidth:2}]},options:{cutout:'58%',plugins:{legend:{display:false},tooltip:{callbacks:{label:(c)=>c.label.replace(/^(\\w+) /,'$1 ')+': '+c.formattedValue+' g'}}},layout:{padding:8},animation:{duration:300}}});
  return window._pieObj;
}

/***** Disease scores *****/
function computeDiseaseScores(n, ingredients=[], meta={}){
  const grams=(k)=>Number(n[k] ?? 0); const z=(x,k)=>x/k; const clip=(x)=>Math.max(0,Math.min(10,x));
  const protein=grams('protein'), fiber=grams('fiber'), sugars=grams('sugarsTotal'), satFat=grams('fatSat'), transFat=grams('fatTrans'), sodiumMg=Number(n.sodiumMg||0), netCarbs=Number(n.netCarbs||0);
  const isUltra=(meta.nova===4)||/artificial|preserv|emulsifier|maltodextrin|color/i.test((ingredients||[]).join(' '));
  const has=(...ks)=> (ingredients||[]).some(t=>ks.some(k=>t.includes(k)));
  const processedMeat=has('nitrite','nitrate','sodium nitrite','bologna','pepperoni','salami','sausage','bacon','ham'); const dyes=has('red 40','yellow 5','yellow 6','blue 1','blue 2'); const sweeteners=has('aspartame','acesulfame','saccharin','sucralose'); const seedOils=has('soybean oil','corn oil','cottonseed oil','canola oil','sunflower oil');
  const cancer=3.0*z(sugars,20)+2.2*z(satFat,10)+2.5*(transFat>0?1:0)+3.0*z(sodiumMg,2000)+2.8*(processedMeat?1:0)+2.0*(dyes?1:0)+2.2*(isUltra?1:0)-1.8*z(fiber,8)-0.6*z(protein,30);
  const diabetes=4.0*z(sugars,20)+3.0*z(Math.max(netCarbs,0),40)+1.0*z(sodiumMg,2000)+1.5*(sweeteners?1:0)+1.5*(isUltra?1:0)-2.5*z(fiber,8)-0.7*z(protein,30);
  const cvd=3.2*z(sodiumMg,2000)+3.2*z(satFat,10)+2.5*(transFat>0?1:0)+1.5*(seedOils?1:0)+1.5*(isUltra?1:0)-2.0*z(fiber,8);
  const nafld=3.8*z(sugars,20)+2.8*z(Math.max(netCarbs,0),40)+1.5*z(satFat,10)+1.5*(isUltra?1:0)-1.5*z(fiber,8);
  const dementia=2.4*(isUltra?1:0)+2.0*z(sugars,20)+1.8*z(satFat,10)+1.2*z(sodiumMg,2000)-1.8*z(fiber,8);
  const gout=3.0*(processedMeat?1:0)+1.2*z(sugars,20);
  const scores={ cancer:clip(cancer), diabetes:clip(diabetes), cvd:clip(cvd), nafld:clip(nafld), dementia:clip(dementia), gout:clip(gout) };
  const overall=clip(0.28*scores.cancer+0.28*scores.diabetes+0.22*scores.cvd+0.12*scores.nafld+0.08*scores.dementia+0.02*scores.gout);
  return { ...scores, overall };
}

/***** Renderers *****/
let pieChart=null, cycleIdx=0;
function renderProduct(p){
  const parts=getNutriments(p);
  const meta={ nova:p.nova_group, alcohol_g:0 };
  const ingredients=(p.ingredients_text||'').toLowerCase().split(/[,;()]/).map(s=>s.trim()).filter(Boolean);
  const brand=p.brands||'Unknown Brand'; const name=p.product_name||'Unknown Product';
  $('productMeta').innerHTML=`<div class="kv"><div class="k">Name</div><div>${name}</div></div><div class="kv"><div class="k">Brand</div><div>${brand}</div></div><div class="kv"><div class="k">Serving Basis</div><div>${parts.basis}</div></div>`;
  if(pieChart){pieChart.destroy();} pieChart=buildPie({...parts});
  $('macroList').innerHTML=`<div>Protein: <b>${parts.protein.toFixed(1)} g</b></div><div>Fat: <b>${parts.fat.toFixed(1)} g</b> (Mono ${parts.fatMono.toFixed(1)}, Poly ${parts.fatPoly.toFixed(1)}, Sat ${parts.fatSat.toFixed(1)}, Trans ${parts.fatTrans.toFixed(1)}, Other ${parts.fatOther.toFixed(1)})</div><div>Carbs: <b>${parts.carbs.toFixed(1)} g</b> (Fiber ${parts.fiber.toFixed(1)}, Sugar ${parts.sugarsTotal.toFixed(1)}, Added ${parts.added.toFixed(1)}, Other ${parts.carbsOther.toFixed(1)})</div><div>Net Carbs: <b>${parts.netCarbs.toFixed(1)} g</b></div><div>Sodium: <b>${Math.round(parts.sodiumMg)} mg</b></div><div>Calories: <b>${Math.round(parts.kcal)} kcal</b></div>`;
  cycleIdx=0; updateCenter(parts); $('centerToggle').onclick=()=>{ cycleIdx=(cycleIdx+1)%4; updateCenter(parts); };
  renderBadges(parts,p); renderDisease(parts,ingredients,meta);
  const top=$('topStatus'); if(top) top.textContent='Loaded: '+name;
}
function updateCenter(parts){ const map=[{label:'Total Calories',value:Math.round(parts.kcal)+' kcal'},{label:'Protein',value:parts.protein.toFixed(1)+' g'},{label:'Net Carbs',value:parts.netCarbs.toFixed(1)+' g'},{label:'Sodium',value:Math.round(parts.sodiumMg)+' mg'}]; $('centerToggle').textContent='Show: '+map[cycleIdx].label; $('centerReadout').textContent=map[cycleIdx].value; }
function addBadge(container,text,level){ const d=document.createElement('div'); d.className='badge b-'+(level||'info'); d.innerHTML=`<span class="dot"></span><span>${text}</span>`; container.appendChild(d); }
function renderBadges(parts,p){ const el=$('badges'); el.innerHTML=''; const highProtein=parts.protein>=20; const lowSugar=parts.added<=5 && parts.sugarsTotal<=8; const highFiber=parts.fiber>=5; const highSodium=parts.sodiumMg>=600; const lowSodium=parts.sodiumMg<=140; const keto=(parts.netCarbs<=8 && parts.fiber>=3) || (parts.netCarbs<=5); const processed=(p.nova_group===4); if(keto) addBadge(el,'Keto-Friendly','good'); if(highProtein) addBadge(el,'High-Protein','good'); if(highFiber) addBadge(el,'High-Fiber','good'); if(lowSugar) addBadge(el,'Low-Sugar','good'); if(lowSodium) addBadge(el,'Low-Sodium','good'); if(highSodium) addBadge(el,'High-Sodium','bad'); if(processed) addBadge(el,'High-Processed','warn'); }
function renderDisease(parts,ingredients,meta){ const s=computeDiseaseScores({protein:parts.protein,fiber:parts.fiber,sugarsTotal:parts.sugarsTotal,fatSat:parts.fatSat,fatTrans:parts.fatTrans,sodiumMg:parts.sodiumMg,netCarbs:parts.netCarbs},ingredients,meta); const db=$('diseaseBadges'); db.innerHTML=''; const dl=$('diseaseList'); dl.innerHTML=''; const rows=[['Overall Risk',s.overall],['Cancer',s.cancer],['Diabetes',s.diabetes],['Cardiovascular',s.cvd],['Fatty Liver (NAFLD)',s.nafld],['Dementia',s.dementia],['Gout',s.gout]]; for (const [l,v] of rows){ const level=v>=7?'bad':v>=4?'warn':'good'; addBadge(db, `${l}: ${v.toFixed(1)}/10`, level);} dl.innerHTML=rows.map(([l,v])=>`<div class="kv"><div class="k">${l}</div><div>${v.toFixed(1)} / 10</div></div>`).join(''); }

/***** Diagnostics *****/
async function runDiagnostics(){
  const out=[]; out.push('Secure Context: '+(isSecureContext?'yes':'NO'));
  out.push('mediaDevices: '+(navigator.mediaDevices?'ok':'missing'));
  try{ const st = navigator.permissions && await navigator.permissions.query({name:'camera'}).catch(()=>null); if (st) out.push('Permissions API: '+st.state); }catch{}
  try{ const list = await navigator.mediaDevices.enumerateDevices(); const vids=list.filter(d=>d.kind==='videoinput'); out.push('Video Inputs: '+vids.length); out.push('Labels: '+vids.map(v=>v.label||'(no label until allowed)').join(' | ')); }catch(e){ out.push('enumerateDevices failed: '+e.name); }
  setStatus(out.join(' ‚Ä¢ '));
}

// Clean up on page leave
window.addEventListener('pagehide', stopScan);
</script>
</body>
</html>
